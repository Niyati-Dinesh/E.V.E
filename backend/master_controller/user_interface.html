<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E.V.E. Chat Interface v4.0</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
        }
        .assistant-message h1 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #60a5fa;
            margin: 1rem 0 0.5rem 0;
            border-bottom: 2px solid #374151;
            padding-bottom: 0.5rem;
        }
        .assistant-message h2 {
            font-size: 1.25rem;
            font-weight: bold;
            color: #7dd3fc;
            margin: 1rem 0 0.5rem 0;
        }
        .assistant-message h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #93c5fd;
            margin: 0.75rem 0 0.5rem 0;
        }
        .assistant-message ul, .assistant-message ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        .assistant-message li {
            margin: 0.3rem 0;
            line-height: 1.6;
        }
        .assistant-message p {
            margin: 0.5rem 0;
            line-height: 1.6;
        }
        .assistant-message strong {
            color: #fbbf24;
            font-weight: 600;
        }
        .assistant-message code {
            background-color: #1f2937;
            color: #10b981;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .assistant-message pre {
            background-color: #0f172a;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
            border: 1px solid #334155;
        }
        .assistant-message pre code {
            background-color: transparent;
            color: #e5e7eb;
            padding: 0;
        }
        .assistant-message blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1rem;
            margin: 1rem 0;
            color: #9ca3af;
        }
        .assistant-message a {
            color: #60a5fa;
            text-decoration: underline;
        }
        .assistant-message hr {
            border: none;
            border-top: 1px solid #374151;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        function EVEUserInterface() {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [userId] = useState('demo_user_' + Math.random().toString(36).substr(2, 9));
            const [conversationId, setConversationId] = useState(null);
            const [masterUrl] = useState('http://localhost:8000');
            const [uploadedFiles, setUploadedFiles] = useState([]);
            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const handleFileUpload = (e) => {
                const files = Array.from(e.target.files);
                setUploadedFiles(prev => [...prev, ...files]);
            };

            const removeFile = (index) => {
                setUploadedFiles(prev => prev.filter((_, i) => i !== index));
            };

            const sendMessage = async () => {
                if (!input.trim() && uploadedFiles.length === 0) return;

                let messageContent = input;
                
                // Add file info to display message
                if (uploadedFiles.length > 0) {
                    const fileNames = uploadedFiles.map(f => f.name).join(', ');
                    messageContent = `${input}\n\nğŸ“ Files: ${fileNames}`;
                }

                const userMessage = {
                    role: 'user',
                    content: messageContent,
                    timestamp: new Date().toISOString(),
                    files: uploadedFiles.map(f => f.name)
                };

                setMessages(prev => [...prev, userMessage]);
                const currentInput = input;
                const currentFiles = uploadedFiles;
                setInput('');
                setUploadedFiles([]);
                setLoading(true);

                try {
                    // Create FormData for file upload
                    const formData = new FormData();
                    formData.append('user_id', userId);
                    formData.append('message', currentInput);
                    
                    if (conversationId) {
                        formData.append('conversation_id', conversationId);
                    }
                    
                    // Add all files
                    currentFiles.forEach(file => {
                        formData.append('files', file);
                    });

                    const response = await fetch(`${masterUrl}/process_message`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    // Parse JSON response
                    const jsonData = await response.json();
                    console.log('ğŸ“¥ Received response:', jsonData); // Debug
                    
                    let data = jsonData.response || jsonData;
                    
                    // Store conversation ID for future messages
                    if (jsonData.conversation_id && !conversationId) {
                        setConversationId(jsonData.conversation_id);
                        console.log('Conversation ID set:', jsonData.conversation_id);
                    }

                    // Check if there's a file to download - check jsonData.file not data.file!
                    let fileInfo = null;
                    if (jsonData.file) {
                        fileInfo = jsonData.file;
                        console.log('ğŸ“ File detected:', fileInfo.filename);
                    }

                    // Clean up response
                    if (typeof data === 'string') {
                        data = data.replace(/\\n/g, '\n');
                        data = data.replace(/\\"/g, '"');
                        
                        if (data.includes('Heres the image:')) {
                            data = data.replace('Heres the image:', 'ğŸ¨ Generated image:');
                        }
                    }

                    const assistantMessage = {
                        role: 'assistant',
                        content: data,
                        timestamp: new Date().toISOString(),
                        file: fileInfo
                    };

                    console.log('ğŸ’¬ Adding message with file:', assistantMessage.file ? assistantMessage.file.filename : 'none');
                    setMessages(prev => [...prev, assistantMessage]);
                } catch (error) {
                    const errorMessage = {
                        role: 'error',
                        content: `âŒ Error: ${error.message}\n\nMake sure:\n- Master controller is running\n- Workers are online\n- Check the terminal for errors`,
                        timestamp: new Date().toISOString()
                    };
                    setMessages(prev => [...prev, errorMessage]);
                }
                setLoading(false);
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            const renderMessage = (msg, idx) => {
                const isUser = msg.role === 'user';
                const isError = msg.role === 'error';

                let content = msg.content;
                let imageUrl = null;

                // Check for image URLs
                if (content.includes('pollinations.ai') || content.includes('image:')) {
                    const urlMatch = content.match(/(https?:\/\/[^\s]+)/);
                    if (urlMatch) {
                        imageUrl = urlMatch[1];
                    }
                }

                // Function to download file
                const downloadFile = (fileData) => {
                    try {
                        const byteCharacters = atob(fileData.content);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const blob = new Blob([byteArray], { type: fileData.mime_type });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileData.filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } catch (error) {
                        console.error('Download failed:', error);
                        alert('Failed to download file');
                    }
                };

                return (
                    <div key={idx} style={{
                        display: 'flex',
                        justifyContent: isUser ? 'flex-end' : 'flex-start',
                        marginBottom: '1.5rem'
                    }}>
                        <div style={{maxWidth: '85%'}}>
                            <div style={{
                                padding: '1.25rem',
                                borderRadius: '0.75rem',
                                backgroundColor: isUser ? '#2563eb' : isError ? '#fee2e2' : '#1f2937',
                                color: isUser ? 'white' : isError ? '#991b1b' : '#e5e7eb',
                                boxShadow: '0 4px 6px rgba(0, 0, 0, 0.3)',
                                border: isUser ? 'none' : '1px solid #374151'
                            }}>
                                {imageUrl ? (
                                    <div>
                                        <p style={{marginBottom: '1rem', fontSize: '0.95rem'}}>
                                            ğŸ¨ Generated image:
                                        </p>
                                        <img 
                                            src={imageUrl} 
                                            alt="Generated" 
                                            style={{
                                                borderRadius: '0.5rem',
                                                maxWidth: '100%',
                                                height: 'auto',
                                                border: '2px solid #374151'
                                            }}
                                            onError={(e) => {
                                                e.target.style.display = 'none';
                                                e.target.insertAdjacentHTML('afterend', 
                                                    '<p style="color: #ef4444; margin-top: 0.5rem;">âš ï¸ Image failed to load</p>'
                                                );
                                            }}
                                        />
                                    </div>
                                ) : isUser ? (
                                    <pre style={{
                                        whiteSpace: 'pre-wrap',
                                        fontFamily: 'inherit',
                                        fontSize: '0.95rem',
                                        margin: 0,
                                        lineHeight: 1.6
                                    }}>{content}</pre>
                                ) : (
                                    <div>
                                        <div 
                                            className="assistant-message"
                                            dangerouslySetInnerHTML={{ 
                                                __html: marked.parse(content, { breaks: true, gfm: true }) 
                                            }}
                                        />
                                        {msg.file && (
                                            <button
                                                onClick={() => downloadFile(msg.file)}
                                                style={{
                                                    marginTop: '1rem',
                                                    padding: '0.75rem 1.5rem',
                                                    backgroundColor: '#10b981',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '0.5rem',
                                                    cursor: 'pointer',
                                                    fontSize: '0.9rem',
                                                    fontWeight: '600',
                                                    boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)',
                                                    transition: 'all 0.2s'
                                                }}
                                                onMouseOver={(e) => e.target.style.backgroundColor = '#059669'}
                                                onMouseOut={(e) => e.target.style.backgroundColor = '#10b981'}
                                            >
                                                ğŸ“„ Download {msg.file.filename}
                                            </button>
                                        )}
                                    </div>
                                )}
                            </div>
                            <div style={{
                                fontSize: '0.7rem',
                                color: '#6b7280',
                                marginTop: '0.25rem',
                                paddingLeft: '0.5rem'
                            }}>
                                {new Date(msg.timestamp).toLocaleTimeString()}
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    height: '100vh',
                    background: 'linear-gradient(to bottom right, #1f2937, #111827)'
                }}>
                    {/* Header */}
                    <div style={{
                        backgroundColor: '#1f2937',
                        borderBottom: '2px solid #374151',
                        padding: '1rem'
                    }}>
                        <h1 style={{
                            fontSize: '1.5rem',
                            fontWeight: 'bold',
                            color: 'white',
                            margin: 0
                        }}>ğŸ¤– E.V.E. System v4.0</h1>
                        <p style={{
                            fontSize: '0.875rem',
                            color: '#9ca3af',
                            margin: '0.25rem 0 0 0'
                        }}>
                            Intelligent AI with File Support & Smart Greetings
                            {conversationId && <span style={{marginLeft: '1rem', color: '#10b981'}}>â— Connected</span>}
                        </p>
                    </div>

                    {/* Quick Actions */}
                    <div style={{
                        backgroundColor: '#1f2937',
                        borderBottom: '1px solid #374151',
                        padding: '0.75rem',
                        display: 'flex',
                        gap: '0.5rem',
                        flexWrap: 'wrap'
                    }}>
                        <button onClick={() => setInput('Hi!')} 
                            style={{padding: '0.5rem 0.75rem', backgroundColor: '#6366f1', color: 'white', borderRadius: '0.375rem', border: 'none', cursor: 'pointer', fontSize: '0.875rem', fontWeight: '500'}}>
                            ğŸ‘‹ Say Hi
                        </button>
                        <button onClick={() => setInput('Generate an image of a sunset over mountains')} 
                            style={{padding: '0.5rem 0.75rem', backgroundColor: '#8b5cf6', color: 'white', borderRadius: '0.375rem', border: 'none', cursor: 'pointer', fontSize: '0.875rem', fontWeight: '500'}}>
                            ğŸ¨ Generate Image
                        </button>
                        <button onClick={() => setInput('Write a Python function to calculate fibonacci numbers')} 
                            style={{padding: '0.5rem 0.75rem', backgroundColor: '#3b82f6', color: 'white', borderRadius: '0.375rem', border: 'none', cursor: 'pointer', fontSize: '0.875rem', fontWeight: '500'}}>
                            ğŸ’» Write Code
                        </button>
                        <button onClick={() => setInput('Write documentation for a REST API login endpoint')} 
                            style={{padding: '0.5rem 0.75rem', backgroundColor: '#10b981', color: 'white', borderRadius: '0.375rem', border: 'none', cursor: 'pointer', fontSize: '0.875rem', fontWeight: '500'}}>
                            ğŸ“„ Documentation
                        </button>
                        <button onClick={() => {
                            setMessages([]);
                            setConversationId(null);
                            setUploadedFiles([]);
                            console.log('Started new conversation');
                        }} 
                            style={{padding: '0.5rem 0.75rem', backgroundColor: '#ef4444', color: 'white', borderRadius: '0.375rem', border: 'none', cursor: 'pointer', fontSize: '0.875rem', fontWeight: '500', marginLeft: 'auto'}}>
                            ğŸ”„ New Conversation
                        </button>
                    </div>

                    {/* Messages */}
                    <div style={{flex: 1, overflowY: 'auto', padding: '1.5rem', backgroundColor: '#111827'}}>
                        {messages.length === 0 ? (
                            <div style={{
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                justifyContent: 'center',
                                height: '100%',
                                textAlign: 'center'
                            }}>
                                <div style={{fontSize: '5rem', marginBottom: '1rem'}}>ğŸ¤–</div>
                                <h2 style={{fontSize: '2rem', fontWeight: 'bold', color: 'white', marginBottom: '0.5rem'}}>
                                    Welcome to E.V.E. v4.0
                                </h2>
                                <p style={{color: '#9ca3af', fontSize: '1.1rem', marginBottom: '2rem', maxWidth: '600px'}}>
                                    Enhanced Virtual Environment with File Support
                                </p>
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: 'repeat(2, 1fr)',
                                    gap: '1rem',
                                    maxWidth: '500px',
                                    color: '#6b7280',
                                    fontSize: '0.9rem'
                                }}>
                                    <div style={{textAlign: 'left'}}>
                                        <div style={{marginBottom: '0.5rem'}}>âœ¨ Upload files with ğŸ“</div>
                                        <div style={{marginBottom: '0.5rem'}}>ğŸ¤– Smart greeting detection</div>
                                    </div>
                                    <div style={{textAlign: 'left'}}>
                                        <div style={{marginBottom: '0.5rem'}}>ğŸ¨ Generate images</div>
                                        <div style={{marginBottom: '0.5rem'}}>ğŸ’» Write & analyze code</div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <>
                                {messages.map(renderMessage)}
                                <div ref={messagesEndRef} />
                            </>
                        )}
                    </div>

                    {/* File Upload Preview */}
                    {uploadedFiles.length > 0 && (
                        <div style={{
                            backgroundColor: '#1f2937',
                            borderTop: '1px solid #374151',
                            padding: '0.75rem'
                        }}>
                            <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                                {uploadedFiles.map((file, idx) => (
                                    <div key={idx} style={{
                                        backgroundColor: '#374151',
                                        padding: '0.5rem 0.75rem',
                                        borderRadius: '0.5rem',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '0.5rem',
                                        fontSize: '0.875rem',
                                        color: 'white',
                                        border: '1px solid #4b5563'
                                    }}>
                                        <span>ğŸ“„ {file.name} ({(file.size / 1024).toFixed(1)} KB)</span>
                                        <button
                                            onClick={() => removeFile(idx)}
                                            style={{
                                                backgroundColor: '#ef4444',
                                                border: 'none',
                                                color: 'white',
                                                cursor: 'pointer',
                                                borderRadius: '0.25rem',
                                                padding: '0.125rem 0.5rem',
                                                fontSize: '0.875rem',
                                                fontWeight: 'bold'
                                            }}
                                        >
                                            Ã—
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Input Area */}
                    <div style={{
                        backgroundColor: '#1f2937',
                        borderTop: '2px solid #374151',
                        padding: '1rem'
                    }}>
                        <div style={{display: 'flex', gap: '0.5rem', alignItems: 'flex-end'}}>
                            <input
                                type="file"
                                ref={fileInputRef}
                                onChange={handleFileUpload}
                                multiple
                                style={{display: 'none'}}
                            />
                            <button
                                onClick={() => fileInputRef.current?.click()}
                                style={{
                                    padding: '0.875rem',
                                    backgroundColor: '#374151',
                                    color: 'white',
                                    borderRadius: '0.5rem',
                                    border: '1px solid #4b5563',
                                    cursor: 'pointer',
                                    fontSize: '1.25rem',
                                    height: '52px',
                                    width: '52px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                }}
                                title="Upload files - now working!"
                            >
                                ğŸ“
                            </button>
                            <textarea
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="Type your message... (Press Enter to send, Shift+Enter for new line)"
                                style={{
                                    flex: 1,
                                    padding: '0.875rem 1rem',
                                    backgroundColor: '#374151',
                                    color: 'white',
                                    borderRadius: '0.5rem',
                                    border: '1px solid #4b5563',
                                    resize: 'none',
                                    fontSize: '0.9rem',
                                    lineHeight: 1.5
                                }}
                                rows="2"
                                disabled={loading}
                            />
                            <button
                                onClick={sendMessage}
                                disabled={loading || (!input.trim() && uploadedFiles.length === 0)}
                                style={{
                                    padding: '0.875rem 1.5rem',
                                    backgroundColor: loading ? '#4b5563' : '#2563eb',
                                    color: 'white',
                                    borderRadius: '0.5rem',
                                    border: 'none',
                                    cursor: loading ? 'not-allowed' : 'pointer',
                                    fontSize: '0.9rem',
                                    fontWeight: 'bold',
                                    height: '52px',
                                    minWidth: '100px'
                                }}
                            >
                                {loading ? 'â³ Processing...' : 'ğŸ“¤ Send'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<EVEUserInterface />, document.getElementById('root'));
    </script>
</body>
</html>